\section{Existing Blockchains are Timely}

\dznote{Mention that we prove timeliness for all flavours of permissionless blockchains
by illustrating the proof for three prototypal example.}

\subsection{Bitcoin}

We now prove that Bitcoin is timely. We work in the Bitcoin Backbone model~\cite{backbone}
in the synchronous setting.

First, we have to make a couple of small changes to the Bitcoin Backbone construction to turn it
into a Temporal Ledger, as the original Bitcoin Backbone construction is a ledger protocol only.
Our Temporal Bitcoin Backbone construction is illustrated in Figure~\ref{fig.temporal-backbone}.
It is clear that the Temporal Bitcoin Backbone construction retains the properties of Common Prefix,
Chain Quality and Chain Growth proven in the original Bitcoin Backbone paper~\cite{backbone}.
The reason is that the only change we make is to add a round number to the block format, and
the validity predicate of an honestly produced block is unaffected by the new validation rules.
Therefore the temporal ledger reported by the Bitcoin Backbone protocol is safe and live.

\begin{figure}
  % TODO(dionyziz): Typeset this

  The Temporal Bitcoin Backbone protocol is the same as the Bitcoin Backbone protocol, except
  for the following changes:

  \begin{enumerate}
    \item The block format is changed to include a round number and looks like this:

    \[
      B = (h, \textsf{ctr}, x, r)
    \]

    where $h$ is the hash of the previous block, \textsf{ctr} is the nonce, $x$ is the
    payload of transactions, and $r$ is a round number.

    \item The genesis block is augmented with the round $0$.
    \item The honest parties mine blocks that contain the current round number.
    \item Whenever a chain is received by an honest party, we add the following rules to
          its validation process:

          \begin{enumerate}
            \item Ensure that the rounds recorded on the received chain are strictly
                  increasing.
            \item Ensure that the round recorded on the tip is less than the current round.
          \end{enumerate}
    \item When the ledger is \textsf{read}, the reported transactions are read from the
          stable part of the chain $\chain[{:}{-k}]$. Each transaction is reported with the
          round of the block in which it is included.
  \end{enumerate}
  \caption{Temporal Bitcoin Backbone construction.}
  \label{fig.temporal-backbone}
\end{figure}

Let $\chain^P_r$ be the chain adopted by an honest party $P$ at the
beginning of round $r$ (as returned by the function \emph{maxvalid}).
For the notation definitions ($k, \ell, \tau, \mu$)
in the following theorem, please refer to the original Bitcoin
Backbone paper.

\begin{theorem}[Bitcoin Timeliness]
  A typical execution of the Temporal Bitcoin Backbone protocol is timely
  with timeliness $v = \max(s, \frac{k + \ell}{\tau}) + 1$.
\end{theorem}
\begin{proof}
  Requirements (1) and (2) of timeliness are satisfied due to the new chain validity rules.
  We will now prove (3).

  Let $P$ be any honest party and $r_1 \leq r_2 \in \mathbb{N}$ be any rounds, and consider
  the ledgers $L^P_{r_1}, L^P_{r_2}$ reported\footnote{
    Recall that the ledger reported at a round is obtained by inspecting the
    chain \emph{adopted} at that round.
  } by $P$ at rounds $r_1, r_2$ respectively.
  Suppose, towards a contradiction, that $L^P_{r_2}[|L^P_{r_1}|{:}]$ contains a transaction
  $\tx$ with recorded round $r \leq r_1 - v$.

  % TODO(dionyziz): figure
  Let $\chain_1, \chain_2$ be the chain that $P$ adopts at round $r_1$
  and $r_2$ respectively.
  It must be true that $|\chain_2| > |\chain_1|$.
  Due to Common Prefix, $\chain_2$ will extend a block in $\chain_1[-k-1{:}]$.
  The transaction $\tx$ is contained in some block $B$ of $\chain_2[|\chain_1[{:}{-k}]|{:}{-k}]$.

  Let $B^*$ be the most recent
  honestly generated block in $\chain_1[{:}{-k}][{-\ell}{:}]$
  (or let $B^*$ be genesis if $|\chain_1| \leq \ell + k$).
  This block will exist by
  Chain Quality because we are looking at a chain chunk of length at least $\ell$ and
  $\mu\ell \geq 1$ (or is genesis).
  Block $B^*$ is honestly generated, so let $r^*$ be the round
  during which $B^*$ was generated, noting that the round recorded in $B^*$ is $r^*$.
  Let $P^*$ be the party who mined $B^*$ at round $r^*$ (or $P^* = P, r^* = 0$ if $B^*$ is
  the genesis block).

  The block $B$ extends a chain that contains $B^*$, so $r > r^*$,
  therefore
  \begin{equation}
    r^* < r_1 - v\label{eq:bitcoin-r-bound}.
  \end{equation}

  Let $\chain^{P^*}_{r^*}$ be the chain that $P^*$ adopts at
  round $r^*$ (this will be the empty chain if $B^*$ is genesis).
  Party $P^*$ extends $\chain^{P^*}_{r^*}$, at round $r^*$, with block $B^*$,
  creating a chain of length $|\chain^{P^*}_{r^*}| + 1$.
  This newly generated chain is broadcasted to the network and
  received by party $P$ at the beginning of round $r^* + 1$.
  Let $\bar \chain^P_{r^* + 2}$ be the chain
  that $P$ \emph{has} at round $r^* + 2$.
  We observe that, at round $r^* + 2$, due to the
  longest chain rule, party $P$ \emph{has} a chain of greater or equal
  length to the one broadcasted by party $P^*$. Hence
  $|\bar \chain^P_{r^* + 2}| \geq |\chain^{P^*}_{r^*}| + 1$. Therefore

   % This is also the chain that $P$ \emph{has} at round $r^* + 2$.

  \[
     |\chain_1| - |\bar \chain^P_{r^* + 2}| \leq
     |\chain_1| - |\chain^{P^*}_{r^*}| - 1 <
     k + \ell\, \label{eq:bitcoin-contradiction}\tag{$\ast$}.
  \]

  For the second inequality, observe that
  $\chain_1$ is the chain of $P$ adopted at round $r_1$,
  whereas $\chain^{P^*}_{r^*}$ is
  the parent chain of $B^*$ and those are spaced at most $k + \ell$ blocks
  apart by the definition of $B^*$.

  On the other hand, by Equation~\ref{eq:bitcoin-r-bound}, $r_1 - (r^* + 2) \geq v - 1 \geq s$ and
  we can apply Chain Growth between rounds $r^* + 2$ and $r_1$
  with parameters $s, \tau$ to obtain
  $|\chain_1| - |\bar \chain^P_{r^* + 2}| \geq \tau(r_1 - (r^* + 2)) \geq \tau (v - 1) \geq
  \tau (\frac{k + \ell}{\tau} + 1 - 1) \geq k + \ell$,
  which is a contradiction because of Equation~(\ref{eq:bitcoin-contradiction}).

  \Qed
\end{proof}

\subsection{Streamlet}

We now prove that the Partially Synchronous Streamlet Protocol is timely
after GST.
We work in the same model as the Streamlet paper~\cite{streamlet}.

First, we have to make a couple of small changes to the Steamlet construction to turn it
into a Temporal Ledger.
The \emph{Temporal Streamlet} protocol is the same as the Streamlet protocol, except
for the following change: When the ledger is \textsf{read}, the reported transactions are
read from the finalized chain and each transaction is reported with round $2 e \Delta$,
where $e$ is the epoch number of the block in which it is included, and $\Delta$ is the
network delay.
With this change, Temporal Streamlet remains safe ---in their language \emph{consistent}--- and live($u$).

An honest party $P$, at the beginning of a round, and
before performing any other action, checks the network and
stores the longest finalized chain.
We define $\chain^P_r$ to be the longest finalized chain stored by an honest
party $P$ at the beginning of round $r$.
Let $G(e)$ be the predicate indicating that epochs $e,e+1,e+2,e+3,e+4$ have honest leaders.

We first show the maximum distance between two consecutive fully honest quintuples
is bounded.

\begin{lemma}[Honest Quintuple Distance] \label{lem:honest-quintuple}
  Consider an execution of the Temporal Streamlet protocol with duration
  of $E$ epochs and $< \frac{1}{3}$ corrupt parties.
  Let $J = \{0,E\} \cup \{0 < e < E: G(e)\}$.
  Then, for all $w \geq \frac{\kappa + \lg \floor*{\frac{E}{5}}}{- \lg \left(1 - \left(\frac{2}{3}\right)^5\right)}$:
  $\Pr [\max_{e \in J}(\min_{\substack{e' > e \\ e' \in J}}(e' - e)) > w] \leq \text{negl($\kappa$)}$.
\end{lemma}
\begin{proof}
  We let $K = \{0, E\} \cup \{e \in \{0, 5, 10 ,\ldots, 5\floor*{\frac{E}{5}}\}: G(e)\}$.
  \atnote{Doublecheck and write about 0 and E}
  It holds that
  $\max_{e \in J}(\min_{\substack{e' > e \\ e' \in J}}(e' - e)) \leq \max_{e \in K}(\min_{\substack{e' > e \\ e' \in K}}(e' - e))$.
  Therefore:

  \begin{gather*}
      \Pr [\max_{e \in J}(\min_{\substack{e' > e \\ e' \in J}}(e' - e)) > w] \leq \\
      \Pr [\max_{e \in K}(\min_{\substack{e' > e \\ e' \in K}}(e' - e)) > w] \leq \\
      \floor*{\frac{E}{5}} \left(1 - \left(\frac{2}{3}\right)^5\right)^w
  \end{gather*}

  For the second inequality, we observe that each chunk is a Bernoulli trial and we
  apply a union bound.
  Letting $F = \left(1 - \left(\frac{2}{3}\right)^5\right)$, we obtain
  $\floor*{\frac{E}{5}} F^w \leq 2^{-\kappa} \Rightarrow
   w \lg F \leq -\kappa - \lg \floor*{\frac{E}{5}} \Rightarrow
   w \geq \frac{\kappa + \lg \floor*{\frac{E}{5}}}{- \lg F}
  $.
  \Qed
\end{proof}

\atnote{Maybe calculate liveness parameter u}
% \begin{theorem}[Streamlet Liveness]
%   The Streamlet protocol is live($u$) in the partially
%   synchronous model with $u \geq ???$, unless with negligible probability.
% \end{theorem}

\begin{lemma}[Latest Finalized Round] \label{lem:latest-finalized-round}
  Consider an execution of the Temporal Streamlet protocol with duration
  of $E$ epochs and $< \frac{1}{3}$ corrupt parties.
  Consider any honest party $P$ and any round $r_1$. Let block
  $B^* = \chain^P_{r_1}[-1]$, with
  epoch $e^*$ and recorded round $r^* = 2e^*\Delta$.
  It holds that $r_1 - r^* \leq 2\Delta(w + 1)$.
\end{lemma}
\begin{proof}
  Let $e = \max(\{\hat e \leq e^* - 3: G(\hat e)\})$ and $e' = \min(\{\hat e > e^* - 3: G(\hat e)\})$.
  From Lemma~\ref{lem:honest-quintuple}, it holds that $e' - e \leq w$.
  By round $2 (e' + 4) \Delta + 1$, all honest parties store a finalized
  chain longer than $\chain^P_{r_1}$. Hence, $r_1 \leq 2 (e' + 4)\Delta$.
  Therefore:

  \begin{align*}
    \makebox[0.5\textwidth][c]{$2e' \Delta - 2e \Delta \leq 2w\Delta$}           && \text{[$e' - e \leq w$]}\\
    \makebox[0.5\textwidth][c]{$2e' \Delta - r^* \leq 2w\Delta - 6\Delta$}       && \text{[$e \leq e^* - 3$]} \\
    \makebox[0.5\textwidth][c]{$r_1 - r^* \leq 2\Delta(w + 1)$}                  && \text{[$r_1 \leq 2 (e' + 4)\Delta$]}
  \end{align*}
  \Qed
\end{proof}


\begin{theorem}[Streamlet Timeliness]
  An execution of the Temporal Streamlet protocol with $< \frac{1}{3}$ corrupt parties is timely
  with timeliness $v = 2\Delta(w + 1)$ in the partially synchronous model after GST.
\end{theorem}
\begin{proof}
  Requirement (1) of timeliness is satisfied because the epoch numbers in any notarized chain
  are non-decreasing.
  Requirement (2) of timeliness is satisfied because a block $B$, of epoch $e$, becomes finalized
  only after the next one gets notarized. This can only happen after round $2 e \Delta + \Delta$,
  which comes after the recorded round $2 e \Delta$ of $B$.
  We will now prove (3).

  Let $P$ be any honest party and $r_1 \leq r_2 \in \N$ be any rounds, and consider
  the ledgers $L^P_{r_1}, L^P_{r_2}$ reported by $P$ at rounds $r_1, r_2$ respectively.
  Suppose, towards a contradiction, that $L^P_{r_2}[|L^P_{r_1}|{:}]$ contains a transaction
  $\tx$ with recorded round $r \leq r_1 - v$.

  Let $\chain_1, \chain_2$ be the longest finalized chain that $P$ stores at the beginning of round $r_1$
  and $r_2$ respectively.
  It must be true that $|\chain_2| > |\chain_1|$, and due to safety, $\chain_2$ will extend $\chain_1$.
  The transaction $\tx$ is contained in some block $B \in \chain_2[|\chain_1|{:}]$,
  with epoch number $e$ and recorded round $r = 2e\Delta$.

  Let $B^* = \chain_1[-1]$, with epoch number $e^*$ and recorded round $r^* = 2e^*\Delta$.
  From Lemma~\ref{lem:latest-finalized-round}, it holds that
  $r_1 - r^* \leq 2\Delta(w + 1)$. Therefore:

  \begin{align*}
    \makebox[0.5\textwidth][c]{$r - r^* \leq 2\Delta(w + 1) - v$}                && \text{[$r \leq r_1 - v$]} \\
    \makebox[0.5\textwidth][c]{$r - r^* \leq 0$}                                 && \text{[$v = 2\Delta(w + 1)$]}
  \end{align*}

  This is a contradiction because block $B$ extends a chain that contains $B^*$,
  and hence $r > r^*$.

  \atnote{Something about genesis needs to be added probably.}
  \Qed
\end{proof}




\subsection{Ouroboros Proof-of-Stake}

\dznote{Prove that Ouroboros is timely}
