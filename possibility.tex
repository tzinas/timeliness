\section{Existing Blockchains are Timely}

\dznote{Mention that we prove timeliness for all flavours of permissionless blockchains
by illustrating the proof for three prototypal example.}

\subsection{Bitcoin}

We now prove that Bitcoin is timely. We work in the Bitcoin Backbone model~\cite{backbone}
in the synchronous setting.

First, we have to make a couple of small changes to the Bitcoin Backbone construction to turn it
into a Temporal Ledger, as the original Bitcoin Backbone construction is a ledger protocol only.
Our Temporal Bitcoin Backbone construction is illustrated in Figure~\ref{fig.temporal-backbone}.
It is clear that the Temporal Bitcoin Backbone construction retains the properties of Common Prefix,
Chain Quality and Chain Growth proven in the original Bitcoin Backbone paper~\cite{backbone}.
The reason is that the only change we make is to add a round number to the block format, and
the validity predicate of an honestly produced block is unaffected by the new validation rules.
Therefore the temporal ledger reported by the Bitcoin Backbone protocol is safe and live.

\begin{figure}
  % TODO(dionyziz): Typeset this

  The Temporal Bitcoin Backbone protocol is the same as the Bitcoin Backbone protocol, except
  for the following changes:

  \begin{enumerate}
    \item The block format is changed to include a round number and looks like this:

    \[
      B = (h, \textsf{ctr}, x, r)
    \]

    where $h$ is the hash of the previous block, \textsf{ctr} is the nonce, $x$ is the
    payload of transactions, and $r$ is a round number.

    \item The genesis block is augmented with the round $0$.
    \item The honest parties mine blocks that contain the current round number.
    \item Whenever a chain is received by an honest party, we add the following rules to
          its validation process:

          \begin{enumerate}
            \item Ensure that the rounds recorded on the received chain are strictly
                  increasing.
            \item Ensure that the round recorded on the tip is less than the current round.
          \end{enumerate}
    \item When the ledger is \textsf{read}, the reported transactions are read from the
          stable part of the chain $\chain[{:}{-k}]$. Each transaction is reported with the
          round of the block in which it is included.
  \end{enumerate}
  \caption{Temporal Bitcoin Backbone construction.}
  \label{fig.temporal-backbone}
\end{figure}

Let $\chain^P_r$ be the chain adopted by an honest party $P$ at the
beginning of round $r$ (as returned by the function \emph{maxvalid}).
For the notation definitions ($k, \ell, \tau, \mu$)
in the following theorem, please refer to the original Bitcoin
Backbone paper.

\begin{theorem}[Bitcoin Timeliness]
  A typical execution of the Temporal Bitcoin Backbone protocol is timely
  with timeliness $v = \max(s, \frac{k + \ell}{\tau}) + 1$.
\end{theorem}
\begin{proof}
  Requirements (1) and (2) of timeliness are satisfied due to the new chain validity rules.
  We will now prove (3).

  Let $P$ be any honest party and $r_1 \leq r_2 \in \mathbb{N}$ be any rounds, and consider
  the ledgers $L^P_{r_1}, L^P_{r_2}$ reported\footnote{
    Recall that the ledger reported at a round is obtained by inspecting the
    chain \emph{adopted} at that round.
  } by $P$ at rounds $r_1, r_2$ respectively.
  Suppose, towards a contradiction, that $L^P_{r_2}[|L^P_{r_1}|{:}]$ contains a transaction
  $\tx$ with recorded round $r \leq r_1 - v$.

  % TODO(dionyziz): figure
  Let $\chain_1, \chain_2$ be the chains that $P$ adopts at rounds $r_1$
  and $r_2$ respectively.
  It must be true that $|\chain_2| > |\chain_1|$.
  Due to Common Prefix, $\chain_2$ will extend a block in $\chain_1[-k-1{:}]$.
  The transaction $\tx$ is contained in some block $B$ of $\chain_2[|\chain_1[{:}{-k}]|{:}{-k}]$.

  Let $B^*$ be the most recent
  honestly generated block in $\chain_1[{:}{-k}][{-\ell}{:}]$
  (or let $B^*$ be genesis if $|\chain_1| \leq \ell + k$).
  This block will exist by
  Chain Quality because we are looking at a chain chunk of length at least $\ell$ and
  $\mu\ell \geq 1$ (or is genesis).
  Block $B^*$ is honestly generated, so let $r^*$ be the round
  during which $B^*$ was generated, noting that the round recorded in $B^*$ is $r^*$.
  Let $P^*$ be the party who mined $B^*$ at round $r^*$ (or $P^* = P, r^* = 0$ if $B^*$ is
  the genesis block).

  The block $B$ extends a chain that contains $B^*$, so $r > r^*$,
  therefore
  \begin{equation}
    r^* < r_1 - v\label{eq:bitcoin-r-bound}.
  \end{equation}

  Let $\chain^{P^*}_{r^*}$ be the chain that $P^*$ adopts at
  round $r^*$ (this will be the empty chain if $B^*$ is genesis).
  Party $P^*$ extends $\chain^{P^*}_{r^*}$, at round $r^*$, with block $B^*$,
  creating a chain of length $|\chain^{P^*}_{r^*}| + 1$.
  This newly generated chain is broadcasted to the network and
  received by party $P$ at the beginning of round $r^* + 1$.
  Let $\bar \chain^P_{r^* + 2}$ be the chain
  that $P$ \emph{has} at round $r^* + 2$.
  We observe that, at round $r^* + 2$, due to the
  longest chain rule, party $P$ \emph{has} a chain of greater or equal
  length to the one broadcasted by party $P^*$. Hence
  $|\bar \chain^P_{r^* + 2}| \geq |\chain^{P^*}_{r^*}| + 1$. Therefore

   % This is also the chain that $P$ \emph{has} at round $r^* + 2$.

  \[
     |\chain_1| - |\bar \chain^P_{r^* + 2}| \leq
     |\chain_1| - |\chain^{P^*}_{r^*}| - 1 <
     k + \ell\, \label{eq:bitcoin-contradiction}\tag{$\ast$}.
  \]

  For the second inequality, observe that
  $\chain_1$ is the chain of $P$ adopted at round $r_1$,
  whereas $\chain^{P^*}_{r^*}$ is
  the parent chain of $B^*$ and those are spaced at most $k + \ell$ blocks
  apart by the definition of $B^*$.

  On the other hand, by Equation~\ref{eq:bitcoin-r-bound}, $r_1 - (r^* + 2) \geq v - 1 \geq s$ and
  we can apply Chain Growth between rounds $r^* + 2$ and $r_1$
  with parameters $s, \tau$ to obtain
  $|\chain_1| - |\bar \chain^P_{r^* + 2}| \geq \tau(r_1 - (r^* + 2)) \geq \tau (v - 1) \geq
  \tau (\frac{k + \ell}{\tau} + 1 - 1) \geq k + \ell$,
  which is a contradiction because of Equation~(\ref{eq:bitcoin-contradiction}).

  \Qed
\end{proof}

\subsection{Streamlet}

We now prove that the Partially Synchronous Streamlet Protocol is timely
after GST.
We work in the same model as the Streamlet paper~\cite{streamlet}.

First, we have to make a couple of small changes to the Steamlet construction to turn it
into a Temporal Ledger.
The \emph{Temporal Streamlet} protocol is the same as the Streamlet protocol, except
for the following change: When the ledger is \textsf{read}, the reported transactions are
read from the finalized chain and each transaction is reported with round $2 e \Delta$,
where $e$ is the epoch number of the block in which it is included, and $\Delta$ is the
network delay.
With these changes, Temporal Streamlet remains safe ---in their language \emph{consistent}--- and live($u$).

We assume that an honest party $P$, at the beginning of a round, and
before performing any other action, checks the network and
stores the longest finalized chain.
We define $\chain^P_r$ to be the longest finalized chain stored by an honest
party $P$ at the beginning of round $r$.

\begin{theorem}[Streamlet Timeliness]
  An execution of the Temporal Streamlet protocol with $< \frac{1}{3}$ corrupt parties is timely
  with timeliness $v = u - 3 \Delta$ in the partially synchronous model after GST.
\end{theorem}
\begin{proof}
  Requirement (1) of timeliness is satisfied because the epoch numbers in any notarized chain
  are non-decreasing.
  Requirement (2) of timeliness is satisfied because a block $B$, of epoch $e$, becomes finalized
  only after the next one gets notarized. This can only happen after round $2 e \Delta + \Delta$,
  which comes after the recorded round $2 e \Delta$ of $B$.
  We will now prove (3).

  Let $P$ be any honest party and $r_1 \leq r_2 \in \mathbb{N}$ be any rounds, and consider
  the ledgers $L^P_{r_1}, L^P_{r_2}$ reported by $P$ at rounds $r_1, r_2$ respectively.
  Suppose, towards a contradiction, that $L^P_{r_2}[|L^P_{r_1}|{:}]$ contains a transaction
  $\tx$ with recorded round $r \leq r_1 - v$.

  Let $\chain_1, \chain_2$ be the chains that $P$ stores at the beginning of rounds $r_1$
  and $r_2$ respectively.
  It must be true that $|\chain_2| > |\chain_1|$, and due to safety, $\chain_2$ will extend $\chain_1$.
  The transaction $\tx$ is contained in some block $B$ of $\chain_2[|\chain_1]|{:}]$.

  Let $e$ be the epoch number of block $B$ and $r = e 2 \Delta$ the recorded round of $B$.
  Let $B^* = \chain_1[-1]$ be the last final block of $\chain_1$. Let $e^*$ be the epoch
  number of $B^*$ and $r^* = e^* 2 \Delta$ the recorded round of $B^*$.
  By their definition, block $B$ extends a chain that contains $B^*$. Hence
  $e > e^*$ and $r > r^*$.
  We will now prove that round $r^*$ cannot be much earlier than round $r_1$.
  \atnote{Maybe this could be a Lemma.}

  \atnote{Something about genesis needs to be added probably.}
  \atnote{Epochs $e'_0,e'_1,e'_2,e'_3,e'_4$ may be in the future.}

  Let $e_0,e_1,e_2,e_3,e_4$ be the last 5 consecutive epochs with honest leaders,
  where $e_3 \leq e^*$. Let $e'_0,e'_1,e'_2,e'_3,e'_4$ be the first 5 consecutive epochs
  with honest leaders, where $e < e'_3$.
  From liveness, by round $e'_4 2 \Delta + 1$, all honest parties will have stored
  a finalized chain ending with the block proposed in epoch $e'_3$. Hence, because
  of $e < e'_3$, it must be true that $r_1 \leq e'_4 2 \Delta$.

  \atnote{A figure is definitely needed.}
  We now examine 2 cases:
  \begin{itemize}
    \item A transaction that is broadcasted by round $e_1 2 \Delta + \Delta$
      will be received by all honest parties by the first round of epoch $e_3$.
      Hence, it will be included in the block proposed by the honest leader at
      epoch $e_3$ and will appear in all honest ledgers by round $e_4 2 \Delta + 1$.

    \item A transaction that is broadcasted after round $e_1 2 \Delta + \Delta$
      may not be included in the block proposed at epoch $e_3$.
      However, the transaction will definitely be included
      in the finalized chain ending at the block proposed at epoch $e'_3$.
      Hence, it will appear in all honest ledgers by round $e'_4 2 \Delta + 1$.
  \end{itemize}

  By liveness, it holds that $e'_4 2 \Delta + 1 - (e_1 2 \Delta + 1) \leq u$.
  Therefore:
  \begin{align*}
    \makebox[0.5\textwidth][c]{$e'_4 2 \Delta - e_1 2 \Delta - \Delta \leq u$}   && \\
    \makebox[0.5\textwidth][c]{$e'_4 2 \Delta - e_3 2 \Delta \leq u - 3 \Delta$} && \text{[$e_3 = e_1 + 4 \Delta$]} \\
    \makebox[0.5\textwidth][c]{$e'_4 2 \Delta - e^* 2 \Delta \leq u - 3 \Delta$} && \text{[$e_3 \leq e^*$]} \\
    \makebox[0.5\textwidth][c]{$r_1 - r^* \leq u - 3 \Delta$}                    && \text{[$r_1 \leq e'_4 2 \Delta$] and [$r^* = e^* 2 \Delta$]} \\
    \makebox[0.5\textwidth][c]{$r - r^* \leq u - v - 3 \Delta$}                  && \text{[$r \leq r_1 - v$]} \\
    \makebox[0.5\textwidth][c]{$r - r^* \leq 0$}                                 && \text{[$v = u - 3 \Delta$]}
  \end{align*}
  which is a contradiction because of $r > r^*$.

  \Qed
\end{proof}




\subsection{Ouroboros Proof-of-Stake}

\dznote{Prove that Ouroboros is timely}
